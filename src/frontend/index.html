<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="formatting.js" async></script>
<script src="parser.js" async></script>
<script>

	jQuery(window).bind('beforeunload', function(){
		return 'IF YOU NAVIGATE AWAY FROM THE GAME YOU WILL BE LOGGED OUT!';
	});
	
	var heart = setInterval(function (){
		socket.send(formatToSend(heartbeatMessage()));
		console.log("Sent heartbeat");
	},5000)

	user  = window.prompt("Please enter username(password is the same)",""); 
	socket = new WebSocket("ws://188.166.94.208:1337");  

	handshake_complete = false;
	connection_established = false;


	socket.onopen= function (){
		console.log("started connection");
		sleepFor(100);
		socket.send(window.btoa("server")+";"+window.btoa(user)+";HANDSHAKE;null;"+new Date().getTime()+";");


	}
	
	socket.onmessage = function (env){
		data = env.data;
		console.log("you most likley recieved this: "+ data);
		msg = new Message(data);
		switch(msg.type){
			case "HANDSHAKE_REPLY":
				console.log("recieved handshake reply");
				console.log(msg.args);
				if(msg.args[0]=="true"){
					handshake_complete = true;
					socket.send(window.btoa("server")+";"+window.btoa(user)+";REGISTRATION;null;"+new Date().getTime()+";"+window.btoa(user)+";"+window.btoa(user)+";");
					console.log("Handshake reply confirmed. Sent registration request")
				}else{
					console.log("handshake failed. attempting login");
//					socket.send("server;"+user+";LOGIN;null;"+new Date().getTime()+";"+user+";"+user+";");
				}
				break;
			case "REGISTRATION_REPLY":
				console.log("Received registration reply");
				if(msg.args[0]=="true"){
					connection_established = true;
					console.log("Registartion complete");
					appendToOut("Welcome to the game :D")

				}else{
					alert("HANDSHAKE FAILED!");
					console.log("Registration failed");
				}
				break;
			case "GENERAL_REPLY":
				switch (msg.action){
						case "look_reply":
							appendToOut( formatTime(msg.time_stamp)+ formatLookReply(msg));
							break;
						case "move_reply":
							appendToOut( formatTime(msg.time_stamp)+ formatMoveReply(msg));
							break;
						case "say":
							appendToOut(formatTime(msg.time_stamp)+formatSayReply(msg));
							break;
						case "whisper_reply":
							appendToOut(formatTime(msg.time_stamp)+formatWhisperReply(msg));
							break;
						case "inventory_reply":
							appendToOut(formatTime(msg.time_stamp)+formatInventoryReply(msg));
							break;
						case "take_reply":
							appendToOut(formatTime(msg.time_stamp)+formatTakeReply(msg));
							break;
						case "examine_reply":
							appendToOut(formatTime(msg.time_stamp)+formatExamineReply(msg));
							break;
						case "cs_reply":
							appendToOut(formatTime(msg.time_stamp)+formatCsReply(msg));
							break;
						case "equip_reply":
							appendToOut(formatTime(msg.time_stamp)+formatEquipReply(msg));
							break;
						case "unequip_reply":
							appendToOut(formatTime(msg.time_stamp)+formatUnequipReply(msg));
							break;
						case "attack_reply":
							appendToOut(formatTime(msg.time_stamp)+formatAttackReply(msg));
							break;
						case "drop_reply":
							appendToOut(formatTime(msg.time_stamp)+formatDropReply(msg));
							break;
						default:
							appendToOut(basicMessageFormat(msg));
							break;
				}
				break;
			case "NOTIFICATION":
				appendToOut(formatTime(msg.time_stamp)+formatNotification(msg));
				break;
			case "GENERAL_ERROR":
				appendToOut(formatTime(msg.time_stamp)+formatError(msg));
				break;
			case "HEARTBEAT_REPLY":
				console.log("recieved heartbeat reply");
				break;
			default:
				appendToOut(basicMessageFormat(msg));

		}
		
	}

	function onInput(){
		val =	document.getElementById("input").value;
		msg =	parseInput(val);
		if(msg != null){
			msg = formatToSend(msg);
			console.log("Sending message: " + msg);
			socket.send(msg);
			document.getElementById("input").value = "";

		}
	}

	function look(){
		msg = formatToSend(new makeRequest("look",[],user));
		console.log("sending message: " + msg);
		socket.send(msg);
	}

	function appendToOut(text){
		out = document.getElementById("output");
		var isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + 1;
		out.innerHTML += text + "<br>";
		if(isScrolledToBottom){
			out.scrollTop = out.scrollHeight - out.clientHeight;
		}
	}

	function sleepFor( sleepDuration ){
	    var now = new Date().getTime();
			while(new Date().getTime() < now + sleepDuration){ /* do nothing */ } 
	}





</script>
</head>

<body>

<div>
	<div id="output" style="overflow:auto; height:400px;font-family: Mono;font-size: 12px;">
		<b>Welcome to the scary university of fear and doom!!!!</b><br>
		This is so fucking beta it is silly.<br>
		<p>
		USAGE:<br>
		If you justtype something into the text field you will say something to all the players in the room.<br>
		To do an action you need to type a ":" first. <br>
		Actions are:<br>
		<b>look</b> Returns a description of the room you are in. <br>
		<b>move [room]</b> Moves the player to [room] if possible. <br>
		<b>whisper [player]</b> Whispers something to the [player]. Only [player] can see this message <br>
		<b>take [item]</b> Tries to pickup [item] <br>
		<b>drop [item]</b> Tries to drop [item] <br>
		<b>examine [item]</b> Examines [item] <br>
		<b>equip [item]</b> Tries to equip item <br>
		<b>unequip</b> Unequips the current item<br>
		<b>attack [player]</b> Attacks [player] <br>
	</div>
	<div>
		<input type="text" id="input" onkeydown="if (event.keyCode == 13) onInput()" style="width:100%;">
	</div>

</div>


</body>

</html>
