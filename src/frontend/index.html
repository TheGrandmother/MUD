<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
<script src="formatter.js"></script>
<script>




$(document).ready(function(){

var out_ = document.getElementById("output");
var c = 0;
var add = setInterval(function() {
		// allow 1px inaccuracy by adding 1
		var isScrolledToBottom = out_.scrollHeight - out_.clientHeight <= out_.scrollTop + 1;
		//TODO Fix so that it just sticks when the user hass scrolled down and stops stiking when the user scrolls upp.
		if(isScrolledToBottom){
			out_.scrollTop = out_.scrollHeight - out_.clientHeight;
			}else{
			out_.scrollTop = out_.scrollHeight - out_.clientHeight;
			}
		}, 1000);
});

	user  = window.prompt("Please enter username(password is the same)",""); 
  ugly_tab = "&nbsp;&nbsp;&nbsp;&nbsp;";	
	socket = new WebSocket("ws://188.166.94.208:1337");  

	socket.onopen= function (){
		appendToOut("started connection");
		sleepFor(100);
		socket.send("server;"+user+";HANDSHAKE;null;"+new Date().getTime()+";");
		appendToOut("Sent handhsake");
		socket.send("server;"+user+";REGISTRATION;null;"+new Date().getTime()+";"+user+";"+user+";");
		appendToOut("Sent registration");

	}
	
	socket.onmessage = function (env){
		data = env.data;
		appendToOut(basicMessageFormat(new Message(data)));
	}

	function ass(){
		val =	document.getElementById("input").value;
		document.getElementById("input").value = "";
		socket.send(val);
		output = document.getElementById("output");
		output.innerHTML += "sent message: " + val + "<br>"
	}

	function look(){
		msg = formatToSend(new makeRequest("look",[],user));
		console.log("sending message: " + msg);
		socket.send(msg);
	}

	function appendToOut(text){
		output = document.getElementById("output");
		output.innerHTML += text + "<br>";
	}

	function sleepFor( sleepDuration ){
	    var now = new Date().getTime();
			while(new Date().getTime() < now + sleepDuration){ /* do nothing */ } 
	}




	function Message(message){
		
		split_array = message.split(";");
		this.receiver = split_array[0];
		this.sender = split_array[1];
		this.type = split_array[2];
		this.action = split_array[3];
		this.time_stamp = split_array[4];

		this.args = [];
	
		for(i = 5; i < split_array.length; i++){
			this.args.push(split_array[i]);
		}

		this.setNow = function () {this.time_stamp = new Date.getTime();}

	}


	function makeRequest(action_,args_,sender_){
		return message = {
			receiver:"server",
			sender:sender_,
			type:"GENERAL_ACTION",
			action:action_,
			time_stamp:""+ new Date().getTime(),
			args:args_.join(";")
		};	
	}

	function formatToSend(m){
		return m.receiver + ";" + m.sender + ";" + m.type + ";" + m.action + ";" + m.time_stamp + ";" + m.args;
	}

	function basicMessageFormat(message){
		str = "Message:<br>";
		str += ugly_tab+"Type: " + message.type + "<br>";
		str += ugly_tab+"Action: " + message.action + "<br>";
		str += ugly_tab+"Time Stamp: " + message.time_stamp + "<br>";
		str += ugly_tab+"Arguments: " + "<br>";
		if(message.args.length == 0){
			str += ugly_tab+ugly_tab+"NONE" + "<br>";
		}else{
			for(i = 0; i < message.args.length; i++){
				str += ugly_tab+ugly_tab+message.args[i] + "<br>";
			}
		
		}

		return str;
		
	}


</script>
</head>

<body>

<div>
	<div id="output" style="overflow:auto; height:400px;">
		test :D<br>
	</div>
	<div>
		<input type="text" id="input" onkeydown="if (event.keyCode == 13) ass()">
		<button onclick="look()">look</button>
	</div>

</div>


</body>

</html>
